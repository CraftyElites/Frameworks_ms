<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit-Switched Voice Calls</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 900px; }
        .user-card { transition: transform 0.2s; }
        .user-card:hover { transform: scale(1.05); }
        .call-status { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        #local-audio, #remote-audio { width: 100%; margin: 10px 0; display: none; } /* Hidden for audio-only */
        .wave { animation: wave 1s ease-in-out infinite alternate; }
        @keyframes wave { from { opacity: 0.5; } to { opacity: 1; } }
    </style>
</head>
<body class="text-white">
    <div class="container mt-4">
        <h1 class="text-center mb-4">ðŸŽ¤ Circuit-Switched Voice Calls</h1>
        <p class="text-center">Current User ID: <strong id="current-user-id">-</strong></p>

        <div class="row mb-4">
            <div class="col">
                <div class="card bg-dark text-white">
                    <div class="card-header">Available Users</div>
                    <div class="card-body">
                        <div class="row" id="users-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="call-controls" class="row hidden">
            <div class="col">
                <div class="card bg-primary text-white">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Call Controls</span>
                        <span id="status" class="badge bg-light text-dark">Ready</span>
                    </div>
                    <div class="card-body text-center">
                        <button id="start-call" class="btn btn-success btn-lg me-2">ðŸ“ž Start Voice Call</button>
                        <button id="end-call" class="btn btn-danger btn-lg" disabled>ðŸ“ž End Call</button>
                        <div id="call-log" class="mt-3 small"></div>
                    </div>
                </div>
            </div>
        </div>

        <audio id="local-audio" autoplay muted></audio>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <!-- Incoming Call Modal -->
    <div class="modal fade" id="incomingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title">Incoming Call</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="wave mb-3">ðŸ“ž</div>
                    <p><strong id="caller-name">-</strong> is calling you!</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button id="accept-call" class="btn btn-success me-2">Accept</button>
                    <button id="reject-call" class="btn btn-danger" data-bs-dismiss="modal">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Config
        const API_BASE = '/api';
        const TOKEN = localStorage.getItem('authToken');
        if (!TOKEN) { alert('Login first!'); throw new Error('No token'); }
        const headers = { Authorization: `Bearer ${TOKEN}` };
        const WS_URL = `ws://10.218.76.230:3000?token=${TOKEN}`; // Include token for auth

        // State
        let currentUserId = null;
        let selectedUserId = null;
        let ws = null;
        let localStream = null;
        let peerConnection = null;
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const logEl = document.getElementById('call-log');

        // DOM
        const usersList = document.getElementById('users-list');
        const currentUserEl = document.getElementById('current-user-id');
        const callControls = document.getElementById('call-controls');
        const statusEl = document.getElementById('status');
        const localAudio = document.getElementById('local-audio');
        const remoteAudio = document.getElementById('remote-audio');
        const incomingModal = new bootstrap.Modal(document.getElementById('incomingModal'));
        const callerNameEl = document.getElementById('caller-name');

        // Utils
        function log(msg) { logEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`; console.log(msg); }
        function updateStatus(text, color = 'light') { statusEl.textContent = text; statusEl.className = `badge bg-${color} text-dark`; }
        function connectWS() {
            ws = new WebSocket(WS_URL);
            ws.onopen = () => { 
                log('WS connected'); 
                if (currentUserId) {
                    ws.send(JSON.stringify({ type: 'join', userId: currentUserId })); 
                }
            };
            ws.onmessage = handleMessage;
            ws.onclose = () => { log('WS disconnected'); setTimeout(connectWS, 3000); };
            ws.onerror = (err) => log('WS error: ' + err);
        }

        function handleMessage(event) {
            const msg = JSON.parse(event.data);
            switch (msg.type) {
                case 'offer':
                    showIncomingCall(msg.from, msg.data);
                    break;
                case 'answer':
                    if (peerConnection) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(msg.data));
                        log('Answer received');
                    }
                    break;
                case 'ice-candidate':
                    if (peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(msg.data));
                        log('ICE candidate received');
                    }
                    break;
                case 'reject':
                    endCall();
                    log('Call rejected');
                    break;
                case 'end':
                    endCall();
                    log('Call ended by other party');
                    break;
            }
        }

        async function fetchCurrentUser() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const res = await fetch(`${API_BASE}/users/${currentUser.id}`, { headers });
                const user = await res.json();
                currentUserId = user.id;
                currentUserEl.textContent = currentUserId;
                connectWS(); // Initialize WebSocket after setting currentUserId
            } catch (err) {
                console.error('Failed to fetch current user:', err);
            }
        }

        async function fetchUsers() {
            try {
                const res = await fetch(`${API_BASE}/users`, { headers });
                const users = await res.json();
                renderUsers(users);
            } catch (err) { console.error(err); }
        }

        function renderUsers(users) {
            usersList.innerHTML = users.map(user => `
                <div class="col-md-4 mb-3">
                    <div class="card user-card bg-secondary text-white h-100" data-id="${user.id}">
                        <img src="${user.profileImage || '/default-avatar.png'}" class="card-img-top rounded-circle mx-auto mt-3" width="80" height="80" alt="${user.name}">
                        <div class="card-body text-center">
                            <h5 class="card-title">${user.name}</h5>
                            <p class="card-text">${user.bio?.substring(0, 50) || ''}...</p>
                            <small>ID: ${user.id} | Following: ${user.isFollowing ? 'Yes' : 'No'}</small>
                        </div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.user-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.user-card').forEach(c => c.classList.remove('border-primary'));
                    card.classList.add('border-primary');
                    selectedUserId = parseInt(card.dataset.id);
                    callControls.classList.remove('hidden');
                });
            });
        }

        async function getLocalStream() {
            if (localStream) return;
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localAudio.srcObject = localStream;
            log('Mic accessed');
        }

        function createPeerConnection() {
            peerConnection?.close();
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.ontrack = (e) => { remoteAudio.srcObject = e.streams[0]; log('Remote stream connected'); };
            peerConnection.onicecandidate = (e) => {
                if (e.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ice-candidate', to: selectedUserId, data: e.candidate }));
                }
            };
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                log(`Connection: ${state}`);
                updateStatus(state === 'connected' ? 'Connected' : state, state === 'connected' ? 'success' : 'warning');
                if (state === 'connected') document.getElementById('end-call').disabled = false;
                if (state === 'failed') endCall();
            };
        }

        async function startCall() {
            if (!selectedUserId) return alert('Select a user!');
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected. Please wait and try again.');
                return;
            }
            await getLocalStream();
            createPeerConnection();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: 'offer', to: selectedUserId, data: offer, from: currentUserId }));
            log('Offer sent');
            updateStatus('Calling...', 'warning');
            document.getElementById('start-call').disabled = true;
        }

        function showIncomingCall(callerId, offer) {
            selectedUserId = callerId; // Set for response
            callerNameEl.textContent = `User ${callerId}`; // Fetch name via API if needed
            incomingModal.show();
            // Store offer for accept
            window.pendingOffer = offer;
        }

        async function acceptCall() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected. Cannot accept call.');
                incomingModal.hide();
                return;
            }
            await getLocalStream();
            createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', to: selectedUserId, data: answer, from: currentUserId }));
            log('Answer sent');
            incomingModal.hide();
            updateStatus('Connected', 'success');
            document.getElementById('end-call').disabled = false;
            document.getElementById('start-call').disabled = true;
        }

        function rejectCall() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'reject', to: selectedUserId, from: currentUserId }));
            }
            incomingModal.hide();
            updateStatus('Rejected', 'danger');
        }

        function endCall() {
            localStream?.getTracks().forEach(track => track.stop());
            localStream = null;
            peerConnection?.close();
            peerConnection = null;
            localAudio.srcObject = null;
            remoteAudio.srcObject = null;
            if (ws && ws.readyState === WebSocket.OPEN && selectedUserId) {
                ws.send(JSON.stringify({ type: 'end', to: selectedUserId, from: currentUserId }));
            }
            document.getElementById('start-call').disabled = false;
            document.getElementById('end-call').disabled = true;
            updateStatus('Ready', 'light');
            log('Call ended');
        }

        // Events
        document.getElementById('start-call').addEventListener('click', startCall);
        document.getElementById('end-call').addEventListener('click', endCall);
        document.getElementById('accept-call').addEventListener('click', acceptCall);
        document.getElementById('reject-call').addEventListener('click', rejectCall);

        // Init
        async function init() {
            await fetchCurrentUser();
            await fetchUsers();
        }
        init();
    </script>
</body>
</html>
